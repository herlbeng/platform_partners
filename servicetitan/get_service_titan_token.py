import requests
from requests.auth import HTTPBasicAuth
import json

def get_service_titan_token(app_id, client_id, client_secret, tenant_id):
    auth_url = f"https://auth-integration.servicetitan.io/connect/token"
    # Configuración de autenticación
    auth = HTTPBasicAuth(client_id, client_secret)

    scopes = [
        "Appointments", "Job Canceled Logs", "Job Cancel Reasons", "Job History", "Job Hold Reasons", "Job Notes", "Jobs", "Job Types", "Project Notes", "Projects", "Project Statuses", "Project Sub-Statuses", "Project Types"
    ]
    
    # Convertir scopes a string separado por espacios
    scope_string = " ".join(scopes)
    
    headers = {
        'Content-Type': 'application/x-www-form-urlencoded',
        'ST-App-Id': app_id
    }
    
    data = {
        'grant_type': 'client_credentials',
        'scope': scope_string
    }
    
    try:
        response = requests.post(
            auth_url,
            auth=auth,
            headers=headers,
            data=data,
            timeout=30
        )
        
        response.raise_for_status()  # Lanza excepción para códigos 4XX/5XX
        
        return response.json()['access_token']
    
    except requests.exceptions.HTTPError as http_err:
        print(f"HTTP error occurred: {http_err}")
        print(f"Response text: {response.text}")
        raise
    except Exception as err:
        print(f"Other error occurred: {err}")
        raise

# Uso ejemplo
try:
    # Reemplaza con tus credenciales reales
    CREDENTIALS = {
        "app_id":"uayv62ftxhlt4",
        "client_id":"cid.l0sg3fc0a50mhz8at28y0rue6",
        "client_secret":"cs1.elvglv8668rpw8efeoqe4wmj2baxcai6fly0pl4b17rmk7voxu",
        "tenant_id":"1270943139"
    }

       
    token = get_service_titan_token(**CREDENTIALS)
    #token = get_service_titan_token("9jxbbcf06a42i","cid.dtq2ekk9l23mnp70y3sowky89","cs2.yk71kq7hj0xyi3x5bd1syl0xazjxm344crle3mkxvripg0m80g","1270943139")
    print(f"Token obtenido con éxito: {token[:15]}...")  # Muestra solo parte del token por seguridad
    
except Exception as e:
    print(f"Fallo en autenticación: {str(e)}")
    print("Verifica lo siguiente:")
    print("1. Que todas las credenciales sean correctas")
    print("2. Que el client_id y client_secret correspondan al mismo cliente")
    print("3. Que el app_id sea correcto")
    print("4. Que el tenant_id sea el adecuado para tu cuenta")
    print("5. Que las credenciales no hayan expirado")


   

#curl --request POST --url https://auth-integration.servicetitan.io/connect/token --header 'Content-Type: application/x-www-form-urlencoded' --data grant_type=client_credentials --data client_id=cid.dtq2ekk9l23mnp70y3sowky89 --data client_secret=cs2.yk71kq7hj0xyi3x5bd1syl0xazjxm344crle3mkxvripg0m80g

#curl --request GET --url https://api-integration.servicetitan.io/settings/v2/tenant/1270943139/employees /
#--header 'Authorization: eyJhbGciOiJSUzI1NiIsImtpZCI6IjkwNjQ0MEU0MUExREVCNTQwMDgxNEY1RUZCQTI0NUYyMzhGRjc1MjVSUzI1NiIsIng1dCI6ImtHUkE1Qm9kNjFRQWdVOWUtNkpGOGpqX2RTVSIsInR5cCI6ImF0K2p3dCJ9.eyJpc3MiOiJodHRwczovL2F1dGgtaW50ZWdyYXRpb24uc2VydmljZXRpdGFuLmlvIiwibmJmIjoxNzQyODY3MTg0LCJpYXQiOjE3NDI4NjcxODQsImV4cCI6MTc0Mjg2ODA4NCwic2NvcGUiOlsidG4uYWNjLmFwY3JlZGl0czpyIiwidG4uYWNjLmFwY3JlZGl0czp3IiwidG4uYWNjLmFwcGF5bWVudHM6ciIsInRuLmFjYy5hcHBheW1lbnRzOnciLCJ0bi5hY2MuZ2xhY2NvdW50czpyIiwidG4uYWNjLmdsYWNjb3VudHM6dyIsInRuLmFjYy5pbnZlbnRvcnlhZGp1c3RtZW50czpyIiwidG4uYWNjLmludmVudG9yeWFkanVzdG1lbnRzOnciLCJ0bi5hY2MuaW52ZW50b3J5YmlsbHM6ciIsInRuLmFjYy5pbnZlbnRvcnliaWxsczp3IiwidG4uYWNjLmludmVudG9yeXJlY2VpcHRzOnIiLCJ0bi5hY2MuaW52ZW50b3J5cmVjZWlwdHM6dyIsInRuLmFjYy5pbnZlbnRvcnl0cmFuc2ZlcnM6ciIsInRuLmFjYy5pbnZlbnRvcnl0cmFuc2ZlcnM6dyIsInRuLmFjYy5pbnZvaWNlaXRlbXM6ciIsInRuLmFjYy5pbnZvaWNlaXRlbXM6dyIsInRuLmFjYy5pbnZvaWNlczpyIiwidG4uYWNjLmludm9pY2VzOnciLCJ0bi5hY2Muam91cm5hbGVudHJpZXM6ciIsInRuLmFjYy5qb3VybmFsZW50cmllczp3IiwidG4uYWNjLnBheW1lbnRzOnIiLCJ0bi5hY2MucGF5bWVudHM6dyIsInRuLmFjYy5wYXltZW50dGVybXM6ciIsInRuLmFjYy5wYXltZW50dGVybXM6dyIsInRuLmFjYy5wYXltZW50dHlwZXM6ciIsInRuLmFjYy5wYXltZW50dHlwZXM6dyIsInRuLmFjYy5wdXJjaGFzZW9yZGVyczpyIiwidG4uYWNjLnB1cmNoYXNlb3JkZXJzOnciLCJ0bi5hY2MucHVyY2hhc2VyZXR1cm5zOnIiLCJ0bi5hY2MucHVyY2hhc2VyZXR1cm5zOnciLCJ0bi5hY2MudGF4em9uZXM6ciIsInRuLmFjYy50YXh6b25lczp3IiwidG4uY3JtLmJvb2tpbmdwcm92aWRlcnRhZ3M6ciIsInRuLmNybS5ib29raW5ncHJvdmlkZXJ0YWdzOnciLCJ0bi5jcm0uYm9va2luZ3M6ciIsInRuLmNybS5ib29raW5nczp3IiwidG4uY3JtLmNvbnRhY3RzOnIiLCJ0bi5jcm0uY29udGFjdHM6dyIsInRuLmNybS5jdXN0b21lcnM6ciIsInRuLmNybS5jdXN0b21lcnM6dyIsInRuLmNybS5sZWFkczpyIiwidG4uY3JtLmxlYWRzOnciLCJ0bi5jcm0ubG9jYXRpb25zOnIiLCJ0bi5jcm0ubG9jYXRpb25zOnciLCJ0bi5jcm0udGFnczpyIiwidG4uY3JtLnRhZ3M6dyIsInRuLmNzaS50ZWNobmljaWFucmF0aW5nOnIiLCJ0bi5jc2kudGVjaG5pY2lhbnJhdGluZzp3IiwidG4uZGlzLmFwcG9pbnRtZW50YXNzaWdubWVudHM6ciIsInRuLmRpcy5hcHBvaW50bWVudGFzc2lnbm1lbnRzOnciLCJ0bi5kaXMuYXJyaXZhbHdpbmRvd3M6ciIsInRuLmRpcy5hcnJpdmFsd2luZG93czp3IiwidG4uZGlzLmJ1c2luZXNzaG91cnM6ciIsInRuLmRpcy5idXNpbmVzc2hvdXJzOnciLCJ0bi5kaXMuY2FwYWNpdHk6ciIsInRuLmRpcy5jYXBhY2l0eTp3IiwidG4uZGlzLmdwc3BpbmdzOnIiLCJ0bi5kaXMuZ3BzcGluZ3M6dyIsInRuLmRpcy5ub25qb2JhcHBvaW50bWVudHM6ciIsInRuLmRpcy5ub25qb2JhcHBvaW50bWVudHM6dyIsInRuLmRpcy50ZWFtczpyIiwidG4uZGlzLnRlYW1zOnciLCJ0bi5kaXMudGVjaG5pY2lhbnNoaWZ0czpyIiwidG4uZGlzLnRlY2huaWNpYW5zaGlmdHM6dyIsInRuLmRpcy56b25lczpyIiwidG4uZGlzLnpvbmVzOnciLCJ0bi5lcXMuaW5zdGFsbGVkZXF1aXBtZW50OnIiLCJ0bi5lcXMuaW5zdGFsbGVkZXF1aXBtZW50OnciLCJ0bi5mcm0uZm9ybXM6ciIsInRuLmZybS5mb3Jtczp3IiwidG4uZnJtLmpvYnM6ciIsInRuLmZybS5qb2JzOnciLCJ0bi5mcm0uc3VibWlzc2lvbnM6ciIsInRuLmZybS5zdWJtaXNzaW9uczp3IiwidG4uaW52LmFkanVzdG1lbnRzOnIiLCJ0bi5pbnYuYWRqdXN0bWVudHM6dyIsInRuLmludi5wdXJjaGFzZW9yZGVybWFya3VwczpyIiwidG4uaW52LnB1cmNoYXNlb3JkZXJtYXJrdXBzOnciLCJ0bi5pbnYucHVyY2hhc2VvcmRlcnM6ciIsInRuLmludi5wdXJjaGFzZW9yZGVyczp3IiwidG4uaW52LnB1cmNoYXNlb3JkZXJ0eXBlczpyIiwidG4uaW52LnB1cmNoYXNlb3JkZXJ0eXBlczp3IiwidG4uaW52LnJlY2VpcHRzOnIiLCJ0bi5pbnYucmVjZWlwdHM6dyIsInRuLmludi5yZXR1cm5zOnIiLCJ0bi5pbnYucmV0dXJuczp3IiwidG4uaW52LnJldHVybnR5cGVzOnIiLCJ0bi5pbnYucmV0dXJudHlwZXM6dyIsInRuLmludi50cmFuc2ZlcnM6ciIsInRuLmludi50cmFuc2ZlcnM6dyIsInRuLmludi50cnVja3M6ciIsInRuLmludi50cnVja3M6dyIsInRuLmludi52ZW5kb3JzOnIiLCJ0bi5pbnYudmVuZG9yczp3IiwidG4uaW52LndhcmVob3VzZXM6ciIsInRuLmludi53YXJlaG91c2VzOnciLCJ0bi5qYmNlLmNhbGxyZWFzb25zOnIiLCJ0bi5qYmNlLmNhbGxyZWFzb25zOnciLCJ0bi5qcG0uYXBwb2ludG1lbnRzOnIiLCJ0bi5qcG0uYXBwb2ludG1lbnRzOnciLCJ0bi5qcG0uam9iY2FuY2VsZWRsb2dzOnIiLCJ0bi5qcG0uam9iY2FuY2VsZWRsb2dzOnciLCJ0bi5qcG0uam9iY2FuY2VscmVhc29uczpyIiwidG4uanBtLmpvYmNhbmNlbHJlYXNvbnM6dyIsInRuLmpwbS5qb2JoaXN0b3J5OnIiLCJ0bi5qcG0uam9iaGlzdG9yeTp3IiwidG4uanBtLmpvYmhvbGRyZWFzb25zOnIiLCJ0bi5qcG0uam9iaG9sZHJlYXNvbnM6dyIsInRuLmpwbS5qb2Jub3RlczpyIiwidG4uanBtLmpvYm5vdGVzOnciLCJ0bi5qcG0uam9iczpyIiwidG4uanBtLmpvYnM6dyIsInRuLmpwbS5qb2J0eXBlczpyIiwidG4uanBtLmpvYnR5cGVzOnciLCJ0bi5qcG0ucHJvamVjdG5vdGVzOnIiLCJ0bi5qcG0ucHJvamVjdG5vdGVzOnciLCJ0bi5qcG0ucHJvamVjdHM6ciIsInRuLmpwbS5wcm9qZWN0czp3IiwidG4uanBtLnByb2plY3RzdGF0dXNlczpyIiwidG4uanBtLnByb2plY3RzdGF0dXNlczp3IiwidG4uanBtLnByb2plY3RzdWJzdGF0dXNlczpyIiwidG4uanBtLnByb2plY3RzdWJzdGF0dXNlczp3IiwidG4uanBtLnByb2plY3R0eXBlczpyIiwidG4uanBtLnByb2plY3R0eXBlczp3IiwidG4ubWFkcy5hdHRyaWJ1dGVkbGVhZHM6ciIsInRuLm1hZHMuYXR0cmlidXRlZGxlYWRzOnciLCJ0bi5tYWRzLmNhcGFjaXR5d2FybmluZ3M6ciIsInRuLm1hZHMuY2FwYWNpdHl3YXJuaW5nczp3IiwidG4ubWFkcy5leHRlcm5hbGNhbGxhdHRyaWJ1dGlvbnM6ciIsInRuLm1hZHMuZXh0ZXJuYWxjYWxsYXR0cmlidXRpb25zOnciLCJ0bi5tYWRzLmpvYmF0dHJpYnV0aW9uczpyIiwidG4ubWFkcy5qb2JhdHRyaWJ1dGlvbnM6dyIsInRuLm1hZHMucGVyZm9ybWFuY2U6ciIsInRuLm1hZHMucGVyZm9ybWFuY2U6dyIsInRuLm1hZHMud2ViYm9va2luZ2F0dHJpYnV0aW9uczpyIiwidG4ubWFkcy53ZWJib29raW5nYXR0cmlidXRpb25zOnciLCJ0bi5tYWRzLndlYmxlYWRmb3JtYXR0cmlidXRpb25zOnIiLCJ0bi5tYWRzLndlYmxlYWRmb3JtYXR0cmlidXRpb25zOnciLCJ0bi5tZW0uaW52b2ljZXRlbXBsYXRlczpyIiwidG4ubWVtLmludm9pY2V0ZW1wbGF0ZXM6dyIsInRuLm1lbS5tZW1iZXJzaGlwczpyIiwidG4ubWVtLm1lbWJlcnNoaXBzOnciLCJ0bi5tZW0ubWVtYmVyc2hpcHR5cGVzOnIiLCJ0bi5tZW0ubWVtYmVyc2hpcHR5cGVzOnciLCJ0bi5tZW0ucmVjdXJyaW5nc2VydmljZWV2ZW50czpyIiwidG4ubWVtLnJlY3VycmluZ3NlcnZpY2VldmVudHM6dyIsInRuLm1lbS5yZWN1cnJpbmdzZXJ2aWNlczpyIiwidG4ubWVtLnJlY3VycmluZ3NlcnZpY2VzOnciLCJ0bi5tZW0ucmVjdXJyaW5nc2VydmljZXR5cGVzOnIiLCJ0bi5tZW0ucmVjdXJyaW5nc2VydmljZXR5cGVzOnciLCJ0bi5tcmVwLnJldmlld3M6ciIsInRuLm1yZXAucmV2aWV3czp3IiwidG4ubXJrLmNhbXBhaWduczpyIiwidG4ubXJrLmNhbXBhaWduczp3IiwidG4ubXJrLmNhdGVnb3JpZXM6ciIsInRuLm1yay5jYXRlZ29yaWVzOnciLCJ0bi5tcmsuY29zdHM6ciIsInRuLm1yay5jb3N0czp3IiwidG4ubXJrLnN1cHByZXNzaW9uczpyIiwidG4ubXJrLnN1cHByZXNzaW9uczp3IiwidG4ucGIuY2F0ZWdvcmllczpyIiwidG4ucGIuY2F0ZWdvcmllczp3IiwidG4ucGIuY3NwOnIiLCJ0bi5wYi5jc3A6dyIsInRuLnBiLmRpc2NvdW50c2FuZGZlZXM6ciIsInRuLnBiLmRpc2NvdW50c2FuZGZlZXM6dyIsInRuLnBiLmVxdWlwbWVudDpyIiwidG4ucGIuZXF1aXBtZW50OnciLCJ0bi5wYi5pbWFnZXM6ciIsInRuLnBiLmltYWdlczp3IiwidG4ucGIubWF0ZXJpYWxzOnIiLCJ0bi5wYi5tYXRlcmlhbHM6dyIsInRuLnBiLnByaWNlYm9vazpyIiwidG4ucGIucHJpY2Vib29rOnciLCJ0bi5wYi5zZXJ2aWNlczpyIiwidG4ucGIuc2VydmljZXM6dyIsInRuLnBtdC5jcmVkaXRjYXJkczpyIiwidG4ucG10LmNyZWRpdGNhcmRzOnciLCJ0bi5wcmwuYWN0aXZpdHljb2RlczpyIiwidG4ucHJsLmFjdGl2aXR5Y29kZXM6dyIsInRuLnBybC5lbXBsb3llZXM6ciIsInRuLnBybC5lbXBsb3llZXM6dyIsInRuLnBybC5ncm9zc3BheWl0ZW1zOnIiLCJ0bi5wcmwuZ3Jvc3NwYXlpdGVtczp3IiwidG4ucHJsLmpvYnM6ciIsInRuLnBybC5qb2JzOnciLCJ0bi5wcmwubG9jYXRpb25zOnIiLCJ0bi5wcmwubG9jYXRpb25zOnciLCJ0bi5wcmwubm9uam9idGltZXNoZWV0czpyIiwidG4ucHJsLm5vbmpvYnRpbWVzaGVldHM6dyIsInRuLnBybC5wYXlyb2xsYWRqdXN0bWVudHM6ciIsInRuLnBybC5wYXlyb2xsYWRqdXN0bWVudHM6dyIsInRuLnBybC5wYXlyb2xsczpyIiwidG4ucHJsLnBheXJvbGxzOnciLCJ0bi5wcmwucGF5cm9sbHNldHRpbmdzOnIiLCJ0bi5wcmwucGF5cm9sbHNldHRpbmdzOnciLCJ0bi5wcmwudGVjaG5pY2lhbnM6ciIsInRuLnBybC50ZWNobmljaWFuczp3IiwidG4ucHJsLnRpbWVzaGVldGNvZGVzOnIiLCJ0bi5wcmwudGltZXNoZWV0Y29kZXM6dyIsInRuLnJwci5keW5hbWljdmFsdWVzZXRzOnIiLCJ0bi5ycHIuZHluYW1pY3ZhbHVlc2V0czp3IiwidG4ucnByLnJlcG9ydGNhdGVnb3JpZXM6ciIsInRuLnJwci5yZXBvcnRjYXRlZ29yaWVzOnciLCJ0bi5ycHIucmVwb3J0czpyIiwidG4ucnByLnJlcG9ydHM6dyIsInRuLnNhLnNlcnZpY2VhZ3JlZW1lbnRzOnIiLCJ0bi5zYS5zZXJ2aWNlYWdyZWVtZW50czp3IiwidG4uc2FsLmVzdGltYXRlczpyIiwidG4uc2FsLmVzdGltYXRlczp3IiwidG4uc3Auc2NoZWR1bGVyczpyIiwidG4uc3Auc2NoZWR1bGVyczp3IiwidG4uc3R0LmJ1c2luZXNzdW5pdHM6ciIsInRuLnN0dC5idXNpbmVzc3VuaXRzOnciLCJ0bi5zdHQuZW1wbG95ZWVzOnIiLCJ0bi5zdHQuZW1wbG95ZWVzOnciLCJ0bi5zdHQudGFndHlwZXM6ciIsInRuLnN0dC50YWd0eXBlczp3IiwidG4uc3R0LnRlY2huaWNpYW5zOnIiLCJ0bi5zdHQudGVjaG5pY2lhbnM6dyIsInRuLnN0dC51c2Vycm9sZXM6ciIsInRuLnN0dC51c2Vycm9sZXM6dyIsInRuLnRsYy5jYWxsczpyIiwidG4udGxjLmNhbGxzOnciLCJ0bi50bGMub3B0aW5vdXQ6ciIsInRuLnRsYy5vcHRpbm91dDp3IiwidG4udG1zLmFjdGl2aXRpZXM6ciIsInRuLnRtcy5hY3Rpdml0aWVzOnciLCJ0bi50bXMuYWN0aXZpdHljYXRlZ29yaWVzOnIiLCJ0bi50bXMuYWN0aXZpdHljYXRlZ29yaWVzOnciLCJ0bi50bXMuYWN0aXZpdHl0eXBlczpyIiwidG4udG1zLmFjdGl2aXR5dHlwZXM6dyIsInRuLnRzbS5kYXRhOnIiLCJ0bi50c20uZGF0YTp3IiwidG4udHNtLnRhc2tzOnIiLCJ0bi50c20udGFza3M6dyJdLCJjbGllbnRfaWQiOiJjaWQuZHRxMmVrazlsMjNtbnA3MHkzc293a3k4OSIsImFwaWFwcF9pZCI6IjlqeGJiY2YwNmE0MmkiLCJib29raW5nX3Byb3ZpZGVyIjoicHd6bm9lN3pnNnV5ejVvcHBzZ25tZmRoYyIsImV4dF9kYXRhX2d1aWQiOiI0ZDIwNzA0Yy00ZTI3LTRhYmMtOTU0ZS1mNjMxYjk3YmQxNmYiLCJncHNfcHJvdmlkZXIiOiJOYXRpdmUiLCJvd25lcl9pZCI6InRlbmFudC0xMjcwOTQzMTM5LWVudi1pbnRlZ3JhdGlvbiIsInJlcG9ydF9jYXRlZ29yeSI6InB3em5vZTd6ZzZ1eXo1b3Bwc2dubWZkaGMiLCJzY29wZXNfdmVyc2lvbiI6IjEiLCJ0ZW5hbnQiOiIxMjcwOTQzMTM5IiwianRpIjoiQTFGOTI0QjhDODMyMjczOTk5NUZCMkY0NkU0RjUzNzUifQ.EKrvydQGq6vTgThaN2IZ4rAOti-DweigDX9AjMkCiLtY1vZjaXK726IY2Y4YjZZ_4VEECqr5n_fdtKZ70NH3bhTzZ1pG9ffvRktwxFwngI7Fo2xkTbdNUL1n_o2J2oJcIepDLuE9d538zr9Dz6XEAvivcvCL2J81IGqogk74a7Y4B9boqFgJKRoPX0EiuuukUenFAvv7PboPPPUPafjppm9U-kAEBI6FUwZ4cj3S_-eLMTNk5Irs7nvzePKxljCIjIYDuXb7AJK-93Z4y_xhtPYJBCZZCDaeFV92oR2pscEZBYOhUupzmkuz2Z7XML6QiHMwd5nGZVTG17czIQd22iZYROzU9NasSHXOK-knOBTrt92i7nLVsfydE5OUrdX4FN6RM_IwXvkygcZWgINYe3WXjzQBJHEjHM3l_2-kAc6TnUIS-usmk_8nXJGdHRRDHtfLWMIst9op1I-fJRHWxLgFJetbOxap1epsRrxZelmp62uZz5M9gscXN25z5c3w_wXA-HLfUv8szDcDH52ZVkS5Wh37CRAE4Bxx17M7Hw7zyQoK1GuJCENGX7EqtikIH00hsOBGwOuOJ3q6XbFAbtfn1tE6V8U94G77QYHd9Ea0Z2sLw7OSBbKcvUsT5tGQT5cEeoj9JMfj7wL9v96zThfk5fIj7WyZPpk_tXDl_j0' /
#--header 'ST-App-Key: 9jxbbcf06a42i'

#curl --request GET --url https://api-integration.servicetitan.io/settings/v2/tenant/1270943139/employees --header 'ST-App-Key: 9jxbbcf06a42i'


#CREDENTIALS = {
#        "app_id":"9jxbbcf06a42i",
#        "client_id":"cid.dtq2ekk9l23mnp70y3sowky89",
#        "client_secret":"cs2.yk71kq7hj0xyi3x5bd1syl0xazjxm344crle3mkxvripg0m80g",
#        "tenant_id":"1270943139"
#    }


#https://auth-integration.servicetitan.io/connect/token?grant_type=client_credentials&client_id=cid.dtq2ekk9l23mnp70y3sowky89&client_secret=cs2.yk71kq7hj0xyi3x5bd1syl0xazjxm344crle3mkxvripg0m80g